<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BUMDes CMMS - Solusi Terpadu</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @media print { 
            body * { visibility: hidden; } 
            #struk-thermal, #struk-thermal * { visibility: visible; } 
            #struk-thermal { position: absolute; left: 0; top: 0; width: 58mm; display: block !important; } 
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
    </style>
</head>
<body class="bg-gray-50 text-slate-800 pb-24">

    <header class="bg-white border-b-4 border-green-600 p-4 sticky top-0 z-50 shadow-md">
        <div class="container mx-auto flex items-center gap-4">
            <img src="https://i.ibb.co.com/8gjqjMfB/logo-cmmsc.jpg" class="h-14 w-14 rounded">
            <div>
                <h1 class="font-black text-green-800 text-lg leading-tight">BUMDes CIKAHURIPAN MAKMUR MANDIRI</h1>
                <p class="text-[10px] font-bold text-gray-500 uppercase">Unit Perdagangan & Jasa - Klapanunggal, Bogor</p>
            </div>
        </div>
    </header>

    <div class="container mx-auto p-4">
        <div class="grid grid-cols-2 lg:grid-cols-5 gap-3 mb-6">
            <div class="bg-blue-800 text-white p-3 rounded-lg shadow">
                <p class="text-[9px] uppercase opacity-70">Tunai</p>
                <p id="s-tunai" class="text-sm font-bold">Rp 0</p>
            </div>
            <div class="bg-blue-700 text-white p-3 rounded-lg shadow">
                <p class="text-[9px] uppercase opacity-70">BRI</p>
                <p id="s-bri" class="text-sm font-bold">Rp 0</p>
            </div>
            <div class="bg-blue-600 text-white p-3 rounded-lg shadow">
                <p class="text-[9px] uppercase opacity-70">Mandiri</p>
                <p id="s-mandiri" class="text-sm font-bold">Rp 0</p>
            </div>
            <div class="bg-blue-500 text-white p-3 rounded-lg shadow">
                <p class="text-[9px] uppercase opacity-70">DANA</p>
                <p id="s-dana" class="text-sm font-bold">Rp 0</p>
            </div>
            <div class="bg-red-600 text-white p-3 rounded-lg shadow col-span-2 lg:col-span-1">
                <p class="text-[9px] uppercase opacity-70">Total Pengeluaran</p>
                <p id="s-keluar" class="text-sm font-bold">Rp 0</p>
            </div>
        </div>

        <div class="flex bg-white rounded-lg shadow mb-6 overflow-hidden border">
            <button onclick="openTab('penjualan')" class="flex-1 p-3 text-xs font-bold border-r hover:bg-gray-50 active:bg-green-50">PENJUALAN</button>
            <button onclick="openTab('stok')" class="flex-1 p-3 text-xs font-bold border-r hover:bg-gray-50 active:bg-green-50">KELOLA STOK</button>
            <button onclick="openTab('laporan')" class="flex-1 p-3 text-xs font-bold hover:bg-gray-50 active:bg-green-50">LAPORAN</button>
        </div>

        <div id="penjualan" class="tab-content active space-y-4">
            <div class="bg-white p-6 rounded-xl shadow-sm border">
                <h2 class="font-bold text-blue-600 mb-4 tracking-tighter uppercase text-sm">üõí Kasir Penjualan</h2>
                <div class="space-y-4">
                    <div>
                        <label class="text-[10px] font-bold text-gray-400">PILIH BARANG</label>
                        <select id="pilih_barang" onchange="setHarga()" class="w-full p-3 bg-gray-50 border rounded-lg font-bold"></select>
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-gray-400">HARGA JUAL</label>
                        <input type="number" id="jual_harga" readonly class="w-full p-3 bg-yellow-50 border rounded-lg font-mono text-lg font-bold text-blue-700" placeholder="0">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-gray-400">METODE PEMBAYARAN</label>
                        <select id="metode_bayar" class="w-full p-3 border rounded-lg font-bold text-gray-700">
                            <option value="Kas Tunai">Kas Tunai</option>
                            <option value="Bank BRI">Bank BRI</option>
                            <option value="Bank Mandiri">Bank Mandiri</option>
                            <option value="Akun DANA">Akun DANA</option>
                        </select>
                    </div>
                    <button onclick="prosesJual()" id="btnJual" class="w-full bg-blue-600 text-white py-4 rounded-xl font-black shadow-lg hover:bg-blue-700 transition-all">PROSES & CETAK STRUK</button>
                </div>
            </div>
        </div>

        <div id="stok" class="tab-content space-y-4">
            <div class="bg-white p-6 rounded-xl shadow-sm border">
                <h2 class="font-bold text-green-600 mb-4 uppercase text-sm">üì¶ Tambah Unit Barang/Jasa</h2>
                <div class="grid gap-4">
                    <input type="text" id="in_nama" placeholder="Nama Barang/Jasa" class="border p-3 rounded-lg outline-green-500">
                    <div class="grid grid-cols-2 gap-2">
                        <input type="number" id="in_beli" placeholder="Harga Beli" class="border p-3 rounded-lg outline-green-500">
                        <input type="number" id="in_jual" placeholder="Harga Jual" class="border p-3 rounded-lg outline-green-500">
                    </div>
                    <button onclick="simpanBarang()" id="btnStok" class="bg-green-600 text-white py-3 rounded-lg font-bold hover:bg-green-700 transition-all">SIMPAN KE STOK</button>
                </div>
            </div>
        </div>

        <div id="laporan" class="tab-content">
            <div class="bg-white rounded-xl shadow-sm border overflow-hidden">
                <table class="w-full text-left text-xs">
                    <thead class="bg-gray-100 uppercase font-bold text-gray-600 border-b">
                        <tr>
                            <th class="p-3">Nama Barang</th>
                            <th class="p-3 text-center">Masuk</th>
                            <th class="p-3 text-center">Keluar</th>
                            <th class="p-3 text-right">Sisa Stok</th>
                        </tr>
                    </thead>
                    <tbody id="tabel-stok"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="struk-thermal" class="hidden font-mono text-[9pt] p-2" style="width: 58mm;">
        <center>
            <img src="https://i.ibb.co.com/8gjqjMfB/logo-cmmsc.jpg" style="width: 35px; margin-bottom:5px;">
            <div style="font-weight:bold; font-size:10pt;">BUMDes CMMS</div>
            <div style="font-size:7pt">Klapanunggal, Bogor</div>
        </center>
        <hr style="border-top: 1px dashed #000; margin: 8px 0;">
        <div id="isi-struk"></div>
        <hr style="border-top: 1px dashed #000; margin: 8px 0;">
        <center style="font-size:7pt">WA: 082125415593<br>Terima kasih atas kunjungan Anda</center>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzau2XMC8MlUn18nvhHG-nHUgEFFaVr2XZsLyglztNwFVzmq8_uMfgSu9srsTI8KIo/exec";
        let DB_STOK = [];

        window.onload = refreshData;

        function openTab(name) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.getElementById(name).classList.add('active');
        }

        async function refreshData() {
            try {
                const res = await fetch(SCRIPT_URL);
                const data = await res.json();
                
                // Update Tampilan Saldo
                document.getElementById('s-tunai').innerText = "Rp " + data.tunai.toLocaleString();
                document.getElementById('s-bri').innerText = "Rp " + data.bri.toLocaleString();
                document.getElementById('s-mandiri').innerText = "Rp " + data.mandiri.toLocaleString();
                document.getElementById('s-dana').innerText = "Rp " + data.dana.toLocaleString();
                document.getElementById('s-keluar').innerText = "Rp " + data.pengeluaran.toLocaleString();

                // Update Dropdown Kasir
                DB_STOK = data.listBarang;
                const sel = document.getElementById('pilih_barang');
                sel.innerHTML = '<option value="">-- PILIH BARANG --</option>';
                data.listBarang.forEach(b => {
                    const sisa = b.masuk - b.keluar;
                    sel.innerHTML += `<option value="${b.nama}">${b.nama} (Stok: ${sisa})</option>`;
                });

                // Update Tabel Laporan
                const tbody = document.getElementById('tabel-stok');
                tbody.innerHTML = "";
                data.listBarang.forEach(b => {
                    const sisa = b.masuk - b.keluar;
                    tbody.innerHTML += `
                        <tr class="border-b hover:bg-gray-50">
                            <td class="p-3 font-bold">${b.nama}</td>
                            <td class="p-3 text-center">${b.masuk}</td>
                            <td class="p-3 text-center">${b.keluar}</td>
                            <td class="p-3 text-right ${sisa <= 2 ? 'text-red-600' : 'text-blue-600'} font-bold">${sisa}</td>
                        </tr>`;
                });
            } catch (e) { console.error("Sinkronisasi gagal"); }
        }

        function setHarga() {
            const b = DB_STOK.find(x => x.nama == document.getElementById('pilih_barang').value);
            if(b) document.getElementById('jual_harga').value = b.harga;
            else document.getElementById('jual_harga').value = "";
        }

        // --- FUNGSI SIMPAN BARANG DENGAN CLEARANCE & ANTI-DOUBLE CLICK ---
        async function simpanBarang() {
            const btn = document.getElementById('btnStok');
            const inNama = document.getElementById('in_nama');
            const inBeli = document.getElementById('in_beli');
            const inJual = document.getElementById('in_jual');

            if(!inNama.value || !inBeli.value || !inJual.value) return alert("Lengkapi data barang!");

            // Lock Tombol
            btn.disabled = true;
            btn.innerText = "‚è≥ Sedang Menyimpan...";
            btn.classList.replace('bg-green-600', 'bg-gray-400');

            const payload = {
                target: "Barang",
                values: [new Date().toLocaleDateString('id-ID'), inNama.value, inBeli.value, inJual.value, "Admin"]
            };

            try {
                await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) });
                
                // Clearance (Kosongkan Form)
                inNama.value = "";
                inBeli.value = "";
                inJual.value = "";
                
                alert("‚úÖ Stok barang berhasil ditambahkan!");
                refreshData(); 
            } catch (e) {
                alert("‚ùå Gagal terhubung ke server.");
            } finally {
                // Unlock Tombol
                btn.disabled = false;
                btn.innerText = "SIMPAN KE STOK";
                btn.classList.replace('bg-gray-400', 'bg-green-600');
            }
        }

        // --- FUNGSI PROSES JUAL DENGAN CLEARANCE & ANTI-DOUBLE CLICK ---
        async function prosesJual() {
            const btn = document.getElementById('btnJual');
            const selBarang = document.getElementById('pilih_barang');
            const inHarga = document.getElementById('jual_harga');
            const selMetode = document.getElementById('metode_bayar');

            if(!selBarang.value || !inHarga.value) return alert("Pilih barang/jasa!");

            // Lock Tombol
            btn.disabled = true;
            btn.innerText = "‚è≥ Memproses...";
            btn.classList.replace('bg-blue-600', 'bg-gray-400');

            const payload = {
                target: "Penjualan",
                values: [new Date().toLocaleString('id-ID'), "INV-"+Date.now(), selBarang.value, inHarga.value, selMetode.value, "Lunas"]
            };

            try {
                await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) });
                
                // Tampilkan Struk
                document.getElementById('isi-struk').innerHTML = `
                    <div style="display:flex; justify-content:space-between"><span>${new Date().toLocaleDateString('id-ID')}</span><span>${new Date().toLocaleTimeString('id-ID')}</span></div>
                    <br><b>${selBarang.value}</b><br>
                    <div style="display:flex; justify-content:space-between; margin-top:5px;"><span>TOTAL</span><span>Rp ${parseInt(inHarga.value).toLocaleString()}</span></div>
                    <div style="font-size:8pt; margin-top:5px;">Bayar via: ${selMetode.value}</div>
                `;
                
                window.print();

                // Clearance (Kosongkan Form)
                selBarang.value = "";
                inHarga.value = "";
                
                refreshData();
            } catch (e) {
                alert("‚ùå Gagal mengirim data penjualan.");
            } finally {
                // Unlock Tombol
                btn.disabled = false;
                btn.innerText = "PROSES & CETAK STRUK";
                btn.classList.replace('bg-gray-400', 'bg-blue-600');
            }
        }
        // Tambahkan ini di bagian paling atas script Bapak
var password_benar = "cmmsc26"; // Silakan ganti dengan password pilihan Bapak
var pass_input = prompt("Masukkan Password untuk Mengakses Aplikasi:");

if (pass_input != password_benar) {
    alert("Password Salah! Anda tidak diperbolehkan mengakses halaman ini.");
    document.body.innerHTML = "<h1>Akses Ditolak</h1>"; // Menghapus tampilan jika salah
}
    </script>
</body>

</html>
