<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BUMDes CMMS - Kasir Terpadu</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @media print { 
            body * { visibility: hidden; } 
            #struk-thermal, #struk-thermal * { visibility: visible; } 
            #struk-thermal { position: absolute; left: 0; top: 0; width: 58mm; display: block !important; } 
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
    </style>
</head>
<body class="bg-gray-50 text-slate-800 pb-24">

    <header class="bg-white border-b-4 border-green-600 p-4 sticky top-0 z-50 shadow-md">
        <div class="container mx-auto flex items-center gap-4">
            <img src="https://i.ibb.co.com/8gjqjMfB/logo-cmmsc.jpg" class="h-14 w-14 rounded">
            <div>
                <h1 class="font-black text-green-800 text-lg leading-tight">BUMDes CIKAHURIPAN MAKMUR MANDIRI</h1>
                <p class="text-[10px] font-bold text-gray-500 uppercase">Unit Perdagangan & Jasa - Klapanunggal, Bogor</p>
            </div>
        </div>
    </header>

    <div class="container mx-auto p-4">
        <div class="grid grid-cols-2 lg:grid-cols-5 gap-3 mb-6">
            <div class="bg-blue-800 text-white p-3 rounded-lg shadow"><p class="text-[9px] opacity-70">TUNAI</p><p id="s-tunai" class="text-sm font-bold">Rp 0</p></div>
            <div class="bg-blue-700 text-white p-3 rounded-lg shadow"><p class="text-[9px] opacity-70">BRI</p><p id="s-bri" class="text-sm font-bold">Rp 0</p></div>
            <div class="bg-blue-600 text-white p-3 rounded-lg shadow"><p class="text-[9px] opacity-70">MANDIRI</p><p id="s-mandiri" class="text-sm font-bold">Rp 0</p></div>
            <div class="bg-blue-500 text-white p-3 rounded-lg shadow"><p class="text-[9px] opacity-70">DANA</p><p id="s-dana" class="text-sm font-bold">Rp 0</p></div>
            <div class="bg-red-600 text-white p-3 rounded-lg shadow col-span-2 lg:col-span-1"><p class="text-[9px] opacity-70">PENGELUARAN</p><p id="s-keluar" class="text-sm font-bold">Rp 0</p></div>
        </div>

        <div class="flex bg-white rounded-lg shadow mb-6 overflow-hidden border">
            <button onclick="openTab('penjualan')" class="flex-1 p-3 text-xs font-bold border-r hover:bg-gray-50">KASIR</button>
            <button onclick="openTab('stok')" class="flex-1 p-3 text-xs font-bold border-r hover:bg-gray-50">STOK</button>
            <button onclick="openTab('laporan')" class="flex-1 p-3 text-xs font-bold hover:bg-gray-50">LAPORAN</button>
        </div>

        <div id="penjualan" class="tab-content active space-y-4">
            <div class="bg-white p-6 rounded-xl shadow-sm border">
                <h2 class="font-bold text-blue-600 mb-4 uppercase text-sm">ðŸ›’ Kasir Penjualan</h2>
                <div class="space-y-4" id="form-kasir">
                    <div>
                        <label class="text-[10px] font-bold text-gray-400">NAMA PEMBELI</label>
                        <input type="text" id="jual_pembeli" placeholder="Nama Pelanggan / Umum" class="w-full p-3 border rounded-lg font-bold uppercase">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-gray-400">PILIH BARANG</label>
                        <select id="pilih_barang" onchange="hitungTotalJual()" class="w-full p-3 bg-gray-50 border rounded-lg font-bold"></select>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="text-[10px] font-bold text-gray-400">HARGA SATUAN</label>
                            <input type="number" id="jual_harga" readonly class="w-full p-3 bg-gray-100 border rounded-lg font-bold text-blue-700">
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-gray-400">JUMLAH BELI</label>
                            <input type="number" id="jual_qty" value="1" oninput="hitungTotalJual()" class="w-full p-3 border rounded-lg font-bold text-center border-blue-500">
                        </div>
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-gray-400">TOTAL BAYAR</label>
                        <input type="text" id="jual_total_tampil" readonly class="w-full p-3 bg-yellow-100 border rounded-lg font-mono text-xl font-black text-blue-800" value="Rp 0">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-gray-400">METODE PEMBAYARAN</label>
                        <select id="metode_bayar" class="w-full p-3 border rounded-lg font-bold">
                            <option value="Kas Tunai">Kas Tunai</option>
                            <option value="Bank BRI">Bank BRI</option>
                            <option value="Bank Mandiri">Bank Mandiri</option>
                            <option value="Akun DANA">Akun DANA</option>
                        </select>
                    </div>
                    <button onclick="prosesJual()" id="btnJual" class="w-full bg-blue-600 text-white py-4 rounded-xl font-black shadow-lg hover:bg-blue-700 transition-all">PROSES & CETAK STRUK</button>
                </div>
            </div>
        </div>

        <div id="stok" class="tab-content space-y-4">
            <div class="bg-white p-6 rounded-xl shadow-sm border">
                <h2 class="font-bold text-green-600 mb-4 uppercase text-sm">ðŸ“¦ Tambah Stok Barang</h2>
                <div class="grid gap-4" id="form-stok">
                    <input type="text" id="in_nama" placeholder="Nama Barang/Jasa" class="border p-3 rounded-lg font-bold">
                    <div class="grid grid-cols-3 gap-2">
                        <input type="number" id="in_beli" placeholder="Hrg Beli" class="border p-3 rounded-lg">
                        <input type="number" id="in_jual" placeholder="Hrg Jual" class="border p-3 rounded-lg">
                        <input type="number" id="in_qty" placeholder="Stok" class="border p-3 rounded-lg border-green-500 font-bold">
                    </div>
                    <button onclick="simpanBarang()" id="btnStok" class="bg-green-600 text-white py-3 rounded-lg font-bold">SIMPAN KE STOK</button>
                </div>
            </div>
        </div>

        <div id="laporan" class="tab-content">
            <div class="bg-white rounded-xl shadow-sm border overflow-hidden text-xs">
                <table class="w-full">
                    <thead class="bg-gray-100 uppercase font-bold text-gray-600 border-b">
                        <tr><th class="p-3 text-left">Nama Barang</th><th class="p-3 text-center">In</th><th class="p-3 text-center">Out</th><th class="p-3 text-right">Sisa</th></tr>
                    </thead>
                    <tbody id="tabel-stok"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="struk-thermal" class="hidden font-mono text-[9pt] p-2" style="width: 58mm; line-height: 1.2;">
        <center>
            <div style="font-weight:bold; font-size:11pt;">BUMDes CMMS</div>
            <div style="font-size:7pt">Klapanunggal, Bogor</div>
        </center>
        <hr style="border-top: 1px dashed #000; margin: 5px 0;">
        <div id="isi-struk"></div>
        <hr style="border-top: 1px dashed #000; margin: 5px 0;">
        <center style="font-size:7pt">Terima kasih atas kunjungan Anda</center>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwSiqEMZnte1tWkP7qqUrn7bi19p8v_iHfz2JLf_rRZ-345uXU1kVURsKip-YiUrFw9/exec";
        let DB_STOK = [];

        window.onload = function() {
            const pass = prompt("Password Akses:");
            if(pass !== "cmmsc26") {
                alert("Salah!");
                document.body.innerHTML = "Akses Ditolak";
            } else {
                refreshData();
            }
        };

        function openTab(name) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.getElementById(name).classList.add('active');
        }

        async function refreshData() {
            try {
                const res = await fetch(SCRIPT_URL);
                const data = await res.json();
                document.getElementById('s-tunai').innerText = "Rp " + data.tunai.toLocaleString();
                document.getElementById('s-bri').innerText = "Rp " + data.bri.toLocaleString();
                document.getElementById('s-mandiri').innerText = "Rp " + data.mandiri.toLocaleString();
                document.getElementById('s-dana').innerText = "Rp " + data.dana.toLocaleString();
                document.getElementById('s-keluar').innerText = "Rp " + data.pengeluaran.toLocaleString();

                DB_STOK = data.listBarang;
                const sel = document.getElementById('pilih_barang');
                sel.innerHTML = '<option value="">-- PILIH BARANG --</option>';
                data.listBarang.forEach(b => {
                    sel.innerHTML += `<option value="${b.nama}">${b.nama} (Stok: ${b.masuk - b.keluar})</option>`;
                });

                const tbody = document.getElementById('tabel-stok');
                tbody.innerHTML = data.listBarang.map(b => `
                    <tr class="border-b"><td class="p-3 font-bold">${b.nama}</td><td class="p-3 text-center">${b.masuk}</td><td class="p-3 text-center">${b.keluar}</td><td class="p-3 text-right font-bold">${b.masuk - b.keluar}</td></tr>
                `).join('');
            } catch (e) { console.log("Gagal sinkron"); }
        }

        function hitungTotalJual() {
            const b = DB_STOK.find(x => x.nama == document.getElementById('pilih_barang').value);
            const qty = document.getElementById('jual_qty').value || 0;
            if(b) {
                document.getElementById('jual_harga').value = b.harga;
                document.getElementById('jual_total_tampil').value = "Rp " + (b.harga * qty).toLocaleString();
            }
        }

        // FUNGSI CLEARANCE UNTUK RESET FORM
        function clearFormKasir() {
            document.getElementById('jual_pembeli').value = "";
            document.getElementById('pilih_barang').value = "";
            document.getElementById('jual_harga').value = "";
            document.getElementById('jual_qty').value = "1";
            document.getElementById('jual_total_tampil').value = "Rp 0";
        }

        function clearFormStok() {
            document.getElementById('in_nama').value = "";
            document.getElementById('in_beli').value = "";
            document.getElementById('in_jual').value = "";
            document.getElementById('in_qty').value = "";
        }

        async function simpanBarang() {
            const btn = document.getElementById('btnStok');
            const payload = {
                target: "Barang",
                values: [new Date().toLocaleDateString('id-ID'), document.getElementById('in_nama').value, document.getElementById('in_beli').value, document.getElementById('in_jual').value, "Admin", document.getElementById('in_qty').value]
            };
            
            if(!payload.values[1]) return alert("Nama barang kosong!");

            btn.disabled = true;
            btn.innerText = "MENYIMPAN...";
            try {
                await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) });
                alert("Stok Berhasil Ditambah!");
                clearFormStok(); // Aktifkan Clearance
                refreshData();
            } catch (e) { alert("Gagal!"); }
            btn.disabled = false;
            btn.innerText = "SIMPAN KE STOK";
        }

        async function prosesJual() {
            const btn = document.getElementById('btnJual');
            const pembeli = document.getElementById('jual_pembeli').value || "Umum";
            const barang = document.getElementById('pilih_barang').value;
            const harga = document.getElementById('jual_harga').value;
            const qty = document.getElementById('jual_qty').value;
            const metode = document.getElementById('metode_bayar').value;
            const total = harga * qty;

            if(!barang || qty < 1) return alert("Pilih barang!");

            btn.disabled = true;
            btn.innerText = "SEDANG MEMPROSES...";
            try {
                await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({
                    target: "Penjualan",
                    values: [new Date().toLocaleString('id-ID'), "INV-"+Date.now(), barang, total, metode, "Lunas", qty, pembeli]
                })});

                document.getElementById('isi-struk').innerHTML = `
                    <div style="font-size:7pt;">ID: INV-${Date.now()}</div>
                    <div style="font-size:7pt;">Pelanggan: ${pembeli.toUpperCase()}</div>
                    <div style="margin:5px 0;"><b>${barang}</b><br>${qty} x Rp ${parseInt(harga).toLocaleString()}</div>
                    <div style="display:flex; justify-content:space-between; font-weight:bold;"><span>TOTAL</span><span>Rp ${total.toLocaleString()}</span></div>
                    <div style="font-size:7pt; margin-top:5px;">Bayar: ${metode}</div>
                `;
                window.print();
                clearFormKasir(); // Aktifkan Clearance
                refreshData();
            } catch (e) { alert("Gagal Simpan!"); }
            btn.disabled = false;
            btn.innerText = "PROSES & CETAK STRUK";
        }
    </script>
</body>
</html>

